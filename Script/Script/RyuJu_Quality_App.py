import streamlit as st
import pandas as pd
import datetime
import os
import uuid

# ==========================================
# è¨­å®šãƒ»å®šæ•°å®šç¾©
# ==========================================
# ã‚¢ãƒ—ãƒªã®åŸºæœ¬è¨­å®š
st.set_page_config(
    page_title="å“è³ªä¸å…·åˆè«–ç†ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãƒ„ãƒ¼ãƒ« é¾æ¨¹(RyuJu)",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ãƒ‡ãƒ¼ã‚¿ä¿å­˜å…ˆã®è¨­å®š
DATA_DIR = "data"
LOG_FILE = os.path.join(DATA_DIR, "quality_fact_log.csv") # å“è³ªå°‚ç”¨ãƒ­ã‚°

# ==========================================
# é–¢æ•°å®šç¾©
# ==========================================

def ensure_data_dir():
    """
    ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã€ãªã‘ã‚Œã°ä½œæˆã™ã‚‹ã€‚
    """
    if not os.path.exists(DATA_DIR):
        try:
            os.makedirs(DATA_DIR)
        except Exception as e:
            st.error(f"ã€ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ã€‘ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")

def save_to_csv(fact_text, machine_type):
    """
    å…¥åŠ›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å“è³ªãƒ­ã‚°CSVã«ä¿å­˜ã™ã‚‹ã€‚
    """
    ensure_data_dir()
    
    now = datetime.datetime.now()
    case_id = str(uuid.uuid4())[:8]
    
    new_data = {
        "timestamp": now.strftime("%Y-%m-%d %H:%M:%S"),
        "case_id": case_id,
        "machine_type": machine_type,
        "raw_facts": fact_text
    }
    
    df = pd.DataFrame([new_data])
    
    try:
        if not os.path.exists(LOG_FILE):
            df.to_csv(LOG_FILE, index=False, encoding="utf-8-sig")
        else:
            df.to_csv(LOG_FILE, mode='a', header=False, index=False, encoding="utf-8-sig")
        return True
    except Exception as e:
        st.error(f"ã€ãƒ­ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼ã€‘CSVã¸ã®æ›¸ãè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
        return False

def generate_prompt_template(facts):
    """
    å“è³ªä¸å…·åˆåˆ†æã«ç‰¹åŒ–ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã€‚
    """
    prompt = f"""
ã‚ãªãŸã¯è£½é€ æ¥­ã®å“è³ªä¿è¨¼ã«ãŠã‘ã‚‹ç†Ÿç·´ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚
ä»¥ä¸‹ã®ã€ç¾å ´ã®äº‹å®Ÿã€‘ã«åŸºã¥ãã€è«–ç†çš„ãªå“è³ªä¸å…·åˆåˆ†æã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

# ã‚ãªãŸã®ã‚¿ã‚¹ã‚¯
1. äº‹å®Ÿã‚’ã€Œ4Mï¼ˆMan, Machine, Material, Methodï¼‰ã€ãŠã‚ˆã³ã€Œç’°å¢ƒ(Environment)ã€ã«åˆ†é¡ã—ã¦æ•´ç†ã—ã¦ãã ã•ã„ã€‚
2. ç™ºç”Ÿã—ãŸäº‹è±¡ã«å¯¾ã—ã¦ã€Œãªãœãªãœåˆ†æï¼ˆ5 Whysï¼‰ã€ã‚’è¡Œã„ã€æ ¹æœ¬åŸå› ã‚’æ¨å®šã—ã¦ãã ã•ã„ã€‚
3. æ¨å®šã•ã‚ŒãŸåŸå› ã«å¯¾ã—ã€ç™ºç”Ÿé˜²æ­¢ç­–ã¨æµå‡ºé˜²æ­¢ç­–ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

# ç¾å ´ã®äº‹å®Ÿï¼ˆå…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼‰
{facts}

# å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
## 1. 4Må¤‰åŒ–ç‚¹ãƒ»äº‹å®Ÿæ•´ç†
(ã“ã“ã«æ•´ç†ã—ãŸå†…å®¹ã‚’è¨˜è¿°)

## 2. ãªãœãªãœåˆ†æï¼ˆæ¨å®šï¼‰
- ç™ºç”Ÿã®ãªãœãªãœ:
  1. ãªãœï¼Ÿ -> 
  ...
- æµå‡ºã®ãªãœãªãœ:
  1. ãªãœï¼Ÿ -> 
  ...

## 3. æ ¹æœ¬åŸå› ã®ç‰¹å®š
- ç™ºç”ŸåŸå› : 
- æµå‡ºåŸå› : 

## 4. å¯¾ç­–æ¡ˆ
- ç™ºç”Ÿå¯¾ç­–ï¼ˆæ’ä¹…ï¼‰:
- æµå‡ºå¯¾ç­–ï¼ˆå³æ™‚ãƒ»æ’ä¹…ï¼‰:
"""
    return prompt

# ==========================================
# ãƒ¡ã‚¤ãƒ³å‡¦ç† (UIæ§‹ç¯‰)
# ==========================================
def main():
    # ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šå…¥åŠ›ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
    with st.sidebar:
        st.title("ğŸ” å“è³ªä¸å…·åˆæƒ…å ±å…¥åŠ›")
        
        # --- ã€å®¢å…ˆæƒ…å ±ã§ã‚ã‹ã‚‹äº‹å®Ÿã€‘ ---
        st.subheader("ã€å®¢å…ˆæƒ…å ±ã§ã‚ã‹ã‚‹äº‹å®Ÿã€‘")
        input_what = st.text_input(
            "ä½•ã‚’", 
            placeholder="ä¾‹ï¼šA00-00000 ã€‡ã€‡ã€‡ã€‡ã€1A11"
        )
        input_how = st.text_input(
            "ã©ã†ã—ãŸ", 
            placeholder="ä¾‹ï¼šã€‡ã€‡ã€‡ã€‡ãŒæ¬ å“ã—ã¦ã„ãŸ"
        )
        
        st.write("---")
        
        # --- ã€å®¢å…ˆæƒ…å ±ã‹ã‚‰èª¿æŸ»ã§åˆ†ã‹ã‚‹äº‹å®Ÿã€‘ ---
        st.subheader("ã€å®¢å…ˆæƒ…å ±ã‹ã‚‰èª¿æŸ»ã§åˆ†ã‹ã‚‹äº‹å®Ÿã€‘")
        input_date = st.date_input("ã„ã¤ï¼ˆæ—¥ä»˜ï¼‰", datetime.date.today())
        input_when_detail = st.text_input(
            "ã„ã¤ï¼ˆè©³ç´°æ™‚åˆ»ãƒ»æ™‚é–“å¸¯ï¼‰", 
            placeholder="ä¾‹ï¼šå¤œå‹¤å¸¯ã€15æ™‚ã”ã‚"
        )
        input_where = st.text_input(
            "ã©ã“ã§", 
            placeholder="ä¾‹ï¼šç¬¬1åŠ å·¥å·¥ç¨‹ã€æ¤œæŸ»ãƒ©ã‚¤ãƒ³"
        )
        input_who = st.text_input(
            "èª°ãŒ", 
            placeholder="ä¾‹ï¼šã‚¤ãƒ‹ã‚·ãƒ£ãƒ«ï¼ˆT.Kï¼‰ã‚’å…¥åŠ›"
        )
        
        st.write("---")
        st.header("ğŸ’¡ å…¥åŠ›ãƒ’ãƒ³ãƒˆ")
        st.info(
            """
            **å“è³ªåˆ†æã®ãƒã‚¤ãƒ³ãƒˆ**
            - ã€Œè‰¯å“ã¨ã®é•ã„ã€ã‚’æ„è­˜ã—ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
            - æ¸¬å®šå€¤ã‚„æ•°å€¤ãŒã‚ã‚Œã°å…·ä½“çš„ã«ã€‚
            """
        )

    # ãƒ¡ã‚¤ãƒ³ç”»é¢
    st.title("ğŸ› ï¸ å“è³ªä¸å…·åˆå¯¾ç­–ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã€Œé¾æ¨¹ - Qualityã€")
    st.markdown("ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ä¸å…·åˆã®äº‹å®Ÿã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

    # å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼‰
    col1, col2 = st.columns([1, 2])
    
    with col1:
        machine_type = st.selectbox(
            "å¯¾è±¡è¨­å‚™ãƒ»ãƒ©ã‚¤ãƒ³",
            ["Aãƒ©ã‚¤ãƒ³", "Bãƒ©ã‚¤ãƒ³", "çµ„ç«‹å·¥ç¨‹", "æ¤œæŸ»å·¥ç¨‹", "ãã®ä»–"],
            help="å“è³ªãƒ‡ãƒ¼ã‚¿ã®çµ±è¨ˆã‚’å–ã‚‹ãŸã‚ã«é¸æŠã—ã¦ãã ã•ã„"
        )
    
    extra_facts = st.text_area(
        "è£œè¶³ã®äº‹å®Ÿï¼ˆæ°—ã¥ãã€å¤‰åŒ–ç‚¹ã€æ™®æ®µã¨ã®é•ã„ãªã©ï¼‰",
        height=100,
        placeholder="ä¾‹ï¼šæ²»å…·ã®å½“ãŸã‚Šé¢ã«ç£¨è€—ãŒè¦‹ã‚‰ã‚ŒãŸã€‚å‰æ—¥ã‹ã‚‰ææ–™ã®ãƒ­ãƒƒãƒˆãŒå¤‰æ›´ã«ãªã£ã¦ã„ãŸã€‚",
        help="äº›ç´°ãªå¤‰åŒ–ãŒæ ¹æœ¬åŸå› ç‰¹å®šã«ç¹‹ãŒã‚Šã¾ã™ã€‚"
    )

    # ç”Ÿæˆãƒœã‚¿ãƒ³
    if st.button("å“è³ªåˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹", type="primary"):
        # å…¨ã¦ã®å…¥åŠ›ã‚’ä¸€ã¤ã®ãƒ†ã‚­ã‚¹ãƒˆã«çµ±åˆ
        combined_facts = f"""
ã€å®¢å…ˆæƒ…å ±ã§ã®äº‹å®Ÿã€‘
ãƒ»å¯¾è±¡: {input_what}
ãƒ»äº‹è±¡: {input_how}

ã€èª¿æŸ»ã«ã‚ˆã‚‹äº‹å®Ÿã€‘
ãƒ»ç™ºç”Ÿæ—¥: {input_date}
ãƒ»è©³ç´°æ™‚é–“: {input_when_detail}
ãƒ»å ´æ‰€: {input_where}
ãƒ»æ‹…å½“: {input_who}

ã€è£œè¶³ãƒ»æ°—ã¥ããƒ»å¤‰åŒ–ç‚¹ã€‘
{extra_facts}
"""
        
        if not input_what or not input_how:
            st.warning("âš ï¸ ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€Œä½•ã‚’ã€ã€Œã©ã†ã—ãŸã€ã¯å¿…é ˆå…¥åŠ›é …ç›®ã§ã™ã€‚")
        else:
            if save_to_csv(combined_facts, machine_type):
                st.success("âœ… å“è³ªãƒ­ã‚°ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚")
            
            generated_text = generate_prompt_template(combined_facts)
            
            st.markdown("---")
            st.subheader("ğŸ¤– AIã¸ã®æŒ‡ç¤ºæ›¸ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰")
            st.code(generated_text, language="markdown")
            
            st.markdown("""
            **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:**
            1. ä¸Šè¨˜ã‚’ã‚³ãƒ”ãƒ¼ã—ã€LLMã«è²¼ã‚Šä»˜ã‘ã¦å¯¾è©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
            2. å®‰å…¨ã«é–¢ã™ã‚‹æ¡ˆä»¶ã¯ã€ä»Šå¾Œä½œæˆäºˆå®šã®ã€Œå®‰å…¨ç”¨ã‚¢ãƒ—ãƒªã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
            """)

if __name__ == "__main__":
    main()
